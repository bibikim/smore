<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gdu.smore.mapper.AdminMapper">

 	<resultMap type="AccessLogDTO" id="AccessLogMap">
		<result column="ACCESS_LOG_NO" property="accessLogNo" />
		<result column="ID" property="id" />
		<result column="LAST_LOGIN_DATE" property="lastLoginDate" />
	</resultMap>
	<resultMap type="SleepUserDTO" id="SleepUserMap">
		<result column="USER_NO" property="userNo" />
		<result column="ID" property="id" />
		<result column="PW" property="pw" />
		<result column="NAME" property="name"/>
		<result column="GRADE" property="grade"/>
		<result column="GENDER" property="gender" />
		<result column="EMAIL" property="email" />
		<result column="MOBILE" property="mobile"/>
		<result column="BIRTHYEAR" property="birthyear" />
		<result column="BIRTHDAY" property="birthday" />
		<result column="POSTCODE" property="postcode" />
		<result column="ROAD_ADDRESS" property="roadAddress" />
		<result column="JIBUN_ADDRESS" property="jibunAddress" />
		<result column="DETAIL_ADDRESS" property="detailAddress" />
		<result column="EXTRA_ADDRESS" property="extraAddress" />
		<result column="AGREE_CODE" property="agreeCode" />
		<result column="SNS_TYPE" property="snsType"/>	
		<result column="USER_STATE" property="userState" />
		<result column="JOIN_DATE" property="joinDate" />
		<result column="LAST_LOGIN_DATE" property="lastLoginDate" />
		<result column="SLEEP_DATE" property="sleepDate" />
	</resultMap>
	<resultMap type="UserDTO" id="UserMap">
		<result column="ROW_NUM" property="rowNum" />
		<result column="USER_NO" property="userNo" />
		<result column="ID" property="id" />
		<result column="PW" property="pw" />
		<result column="NAME" property="name" />
		<result column="NICKNAME" property="nickname" />
		<result column="GRADE" property="grade" />
		<result column="GENDER" property="gender" />
		<result column="EMAIL" property="email" />
		<result column="MOBILE" property="mobile" />
		<result column="BIRTH_YEAR" property="birthYear" />
		<result column="BIRTHDAY" property="birthday" />
		<result column="POSTCODE" property="postcode" />
		<result column="ROAD_ADDRESS" property="roadAddress" />
		<result column="JIBUN_ADDRESS" property="jibunAddress" />
		<result column="DETAIL_ADDRESS" property="detailAddress" />
		<result column="EXTRA_ADDRESS" property="extraAddress" />
		<result column="AGREE_CODE" property="agreeCode" />
		<result column="SNS_TYPE" property="snsType" />
		<result column="JOIN_DATE" property="joinDate" />
		<result column="PW_MODIFY_DATE" property="pwModifyDate" />
		<result column="INFO_MODIFY_DATE" property="infoModifyDate" />
		<result column="SESSION_ID" property="sessionId" />
		<result column="SESSION_LIMIT_DATE" property="sessionLimitDate" />
		<result column="BLACK_CNT" property="blackCnt" />
		<result column="USER_STATE" property="userState" />
		<collection resultMap="AccessLogMap" property="accessLogDTO"></collection>
	</resultMap>
	<resultMap type="AllUserDTO" id="AllUserMap">
		<result column="ROW_NUM" property="rowNum" />
		<collection resultMap="UserMap" property="userDTO"></collection>
		<collection resultMap="SleepUserMap" property="sleepUserDTO"></collection>
	</resultMap> 

	<select id="selectUserCount" resultType="int">
		SELECT COUNT(*)
		  FROM USERS
	</select>
	
	<select id="selectSleepUserCount" resultType="int">
		SELECT COUNT(*)
		  FROM SLEEP_USERS
	</select>
		
	<select id="selectReportUserCount" resultType="int">
		SELECT COUNT(*)
		  FROM REDBELL
	</select>
	
	<select id="selectFreeBoardCount" resultType="int">
		SELECT COUNT(*)
		  FROM FREEBOARD
	</select>
	
	<select id="selectSGroupBoardCount" resultType="int">
		SELECT COUNT(*)
		  FROM S_GROUP
	</select>	
	
<!--    	<select id="selectAllUserList" parameterType="Map" resultMap="AllUserMap">
		SELECT D.ROW_NUM, D.USER_NO, D.ID, D.NAME, D.GENDER, D.JOIN_DATE, D.LAST_LOGIN_DATE, D.USER_STATE
		  FROM (SELECT ROW_NUMBER() OVER(ORDER BY JOIN_DATE DESC) AS ROW_NUM, S.USER_NO, S.ID, S.NAME, S.GENDER, S.JOIN_DATE, S.LAST_LOGIN_DATE, S.USER_STATE
		          FROM (SELECT U.USER_NO, U.ID, U.NAME, U.GENDER, U.JOIN_DATE, NULL SLEEP_DATE, U.USER_STATE,  A.LAST_LOGIN_DATE 
		                  FROM USERS U LEFT OUTER JOIN ACCESS_LOG A
		                    ON U.ID = A.ID 
		                 UNION ALL
                		SELECT USER_NO, ID, NAME, GENDER, JOIN_DATE, LAST_LOGIN_DATE, SLEEP_DATE, USER_STATE
                  		  FROM SLEEP_USERS) S) D
  		 WHERE D.ROW_NUM BETWEEN #{begin} AND #{end} 	                    
	</select> 	 -->
	
<!--   	<select id="selectAllUserList" parameterType="Map" resultMap="AllUserMap">
		SELECT D.ROW_NUM, D.USER_NO, D.ID, D.NAME, D.GENDER, D.JOIN_DATE, D.LAST_LOGIN_DATE
		  FROM (SELECT ROW_NUMBER() OVER(ORDER BY JOIN_DATE DESC) AS ROW_NUM, S.USER_NO, S.ID, S.NAME, S.GENDER, S.JOIN_DATE, S.LAST_LOGIN_DATE 
		          FROM (SELECT U.USER_NO, U.ID, U.NAME, U.GENDER, U.JOIN_DATE, NULL SLEEP_DATE, A.LAST_LOGIN_DATE 
		                  FROM USERS U LEFT OUTER JOIN ACCESS_LOG A
		                    ON U.ID = A.ID 
		                 UNION ALL
                		SELECT USER_NO, ID, NAME, GENDER, JOIN_DATE, LAST_LOGIN_DATE, SLEEP_DATE
                  		  FROM SLEEP_USERS) S) D
  		 WHERE D.ROW_NUM BETWEEN #{begin} AND #{end}
  		 <if test="column=='ID'">AND ${column} LIKE '%' || #{query} || '%'</if>
		 <if test="column=='JOIN_DATE'">AND D.${column} BETWEEN TO_DATE(#{start}, 'yyyy-mm-dd') AND TO_DATE(#{stop}, 'yyyy-mm-dd')</if>
	</select>    -->
	   
	
	 <select id="selectUserByNo" parameterType="int" resultType="UserDTO">
	 	SELECT USER_NO, ID, JOIN_DATE
	 	  FROM USERS 
	 	 WHERE USER_NO = #{userNo}
	 </select> 
	

	
	<select id="selectUsersByQuery" parameterType="map" resultMap="AllUserMap">
			SELECT C.ROW_NUM, C.ID, C.NAME, C.NICKNAME, C.GENDER, C.JOIN_DATE, C.INFO_MODIFY_DATE, C.USER_STATE, C.LAST_LOGIN_DATE
		  	  FROM (SELECT ROW_NUMBER() OVER(ORDER BY B.USER_NO DESC) AS ROW_NUM, B.ID, B.NAME, B.NICKNAME, B.GENDER, B.JOIN_DATE, B.INFO_MODIFY_DATE, B.USER_STATE, B.LAST_LOGIN_DATE
		  		  FROM (SELECT U.USER_NO, U.ID, U.NAME, U.NICKNAME, U.GENDER, U.JOIN_DATE, U.INFO_MODIFY_DATE, U.USER_STATE, A.LAST_LOGIN_DATE
		  		          FROM USERS U LEFT OUTER JOIN ACCESS_LOG A 
		  		            ON U.ID = A.ID
		  		         ORDER BY U.JOIN_DATE DESC) B) C
		  	<where>
		  		C.ROW_NUM BETWEEN #{begin} AND #{end}
		  		<if test="column=='ID'">AND C.${column} LIKE '%' || #{query} || '%'</if>
		  		<if test="column=='JOIN_DATE'"> AND C.${column} BETWEEN STR_TO_DATE(#{start}, '%Y-%m-%d') AND STR_TO_DATE(#{stop}, '%Y-%m-%d')</if>
		  	</where>	         
	</select>
	
	<select id="selectUserCountByQuery" parameterType="Map" resultType="int">
		SELECT COUNT(*)
		  FROM USERS
		<where>
		  <if test="column=='ID'">#{column} LIKE '%' || #{query} || '%'</if>
		  <if test="column=='JOIN_DATE'">${column} BETWEEN STR_TO_DATE(#{start}, '%Y-%m-%d') AND STR_TO_DATE(#{start}, '%Y-%m-%d')</if>
		</where>
	</select>
	
	
<!-- 	<select id="selectSleepUserListByMap" parameterType="map" resultType="SleepUserDTO">
		SELECT B.ROW_NUM, B.USER_NO, B.ID, B.NAME, B.GENDER, B.JOIN_DATE, B.LAST_LOGIN_DATE, B.SLEEP_DATE
		  FROM (SELECT ROW_NUMBER() OVER(ORDER BY USER_NO DESC) AS ROW_NUM, U.USER_NO, U.ID, U.NAME, U.GENDER, U.JOIN_DATE, A.LAST_LOGIN_DATE, U.SLEEP_DATE
		  		  FROM SLEEP_USERS U LEFT OUTER JOIN ACCESS_LOG A
                    		ON U.ID = A.ID) B
		 WHERE B.ROW_NUM BETWEEN #{begin} AND #{end} 		  
	</select> -->

	<select id="selectAllUserList" parameterType="map" resultMap="AllUserMap">
		SELECT B.ROW_NUM, B.USER_NO, B.ID, B.NAME, B.NICKNAME, B.GENDER, B.JOIN_DATE, B.USER_STATE, B.LAST_LOGIN_DATE, NULL SLEEP_DATE
		  FROM (SELECT ROW_NUMBER() OVER(ORDER BY USER_NO DESC) AS ROW_NUM, U.USER_NO, U.ID, U.NAME, U.NICKNAME, U.GENDER, U.JOIN_DATE, U.USER_STATE, U.INFO_MODIFY_DATE, A.LAST_LOGIN_DATE
		  		  FROM USERS U LEFT OUTER JOIN ACCESS_LOG A
                    		ON U.ID = A.ID) B	
        WHERE B.ROW_NUM BETWEEN #{begin} AND #{end}
           			 
		 UNION ALL
		 
		 SELECT B.ROW_NUM, B.USER_NO, B.ID, B.NAME, B.NICKNAME, B.GENDER, B.JOIN_DATE, B.USER_STATE, B.LAST_LOGIN_DATE, B.SLEEP_DATE
		  FROM (SELECT ROW_NUMBER() OVER(ORDER BY USER_NO DESC) AS ROW_NUM, U.USER_NO, U.ID, U.NAME, U.NICKNAME, U.GENDER, U.JOIN_DATE, U.USER_STATE, U.LAST_LOGIN_DATE, U.SLEEP_DATE
		  		  FROM SLEEP_USERS U) B
		 WHERE B.ROW_NUM BETWEEN #{begin} AND #{end} 
		 		  		  
	</select>

	





	<select id="selectUserListByMap" parameterType="map" resultType="UserDTO">
		SELECT B.ROW_NUM, B.USER_NO, B.ID, B.NAME, B.NICKNAME, B.GENDER, B.JOIN_DATE, B.USER_STATE, B.INFO_MODIFY_DATE, B.LAST_LOGIN_DATE
		  FROM (SELECT ROW_NUMBER() OVER(ORDER BY USER_NO DESC) AS ROW_NUM, U.USER_NO, U.ID, U.NAME, U.NICKNAME, U.GENDER, U.JOIN_DATE, U.USER_STATE, U.INFO_MODIFY_DATE, A.LAST_LOGIN_DATE
		  		  FROM USERS U LEFT OUTER JOIN ACCESS_LOG A
                    		ON U.ID = A.ID) B
		 WHERE B.ROW_NUM BETWEEN #{begin} AND #{end} 		  
	</select>

	
	<select id="selectSleepUserListByMap" parameterType="map" resultType="SleepUserDTO">
		SELECT B.ROW_NUM, B.USER_NO, B.ID, B.NAME, B.GENDER, B.JOIN_DATE, B.LAST_LOGIN_DATE, B.SLEEP_DATE
		  FROM (SELECT ROW_NUMBER() OVER(ORDER BY USER_NO DESC) AS ROW_NUM, U.USER_NO, U.ID, U.NAME, U.GENDER, U.JOIN_DATE, U.LAST_LOGIN_DATE, U.SLEEP_DATE
		  		  FROM SLEEP_USERS U) B
		 WHERE B.ROW_NUM BETWEEN #{begin} AND #{end} 		  
	</select> 
	

	
	
	<!-- 자유게시판 조회 -->
	<select id="selectFreeListByMap" parameterType="Map" resultType="FreeBoardDTO">
	    SELECT N.ROW_NUM, N.FREE_NO, N.NICKNAME, N.TITLE, N.CONTENT, N.CREATE_DATE, N.MODIFY_DATE, N.HIT, N.IP
		  FROM (SELECT ROW_NUMBER() OVER(ORDER BY FREE_NO DESC) AS ROW_NUM, FREE_NO, NICKNAME, TITLE, CONTENT, CREATE_DATE, MODIFY_DATE, HIT, IP
		  		FROM FREEBOARD) N
		 WHERE N.ROW_NUM BETWEEN #{begin} AND #{end}
	</select>
	
	<!-- 스터디모집게시판 조회 -->
	<select id="selectStudyListByMap" parameterType="Map" resultType="StudyGroupDTO">
		SELECT A.ROW_NUM, A.STUD_NO, A.NICKNAME, A.TITLE, A.CONTENT, A.CREATE_DATE, A.MODIFY_DATE, A.HIT, A.GENDER, A.REGION, A.WIDO, A.GDO, A.LANG, A.PEOPLE, A.CONTACT, A.STUD_DATE, A.IP
		  FROM (SELECT ROW_NUMBER() OVER(ORDER BY STUD_NO DESC) AS ROW_NUM, STUD_NO, NICKNAME, TITLE, CONTENT, CREATE_DATE, MODIFY_DATE, HIT, GENDER, REGION, WIDO, GDO, LANG, PEOPLE, CONTACT, STUD_DATE, IP
		          FROM S_GROUP B) A
		 WHERE A.ROW_NUM BETWEEN #{begin} AND #{end}
	</select>
	
	<delete id="deleteUserList" parameterType="List">
		DELETE
		  FROM USERS
		  <where>
		  	USER_NO IN 
		 	<foreach collection="list" item="userNo" open="(" close=")" separator=",">  <!-- memberNo를 ()로 덮어주고 separator로 구분을해줌(여러개가 나오니까) -->
		 		#{userNo}
		 	</foreach>
		  </where>
	</delete>
	
	<delete id="deleteAccessLog" parameterType="String">
		DELETE 
		  FROM ACCESS_LOG
		 WHERE  ID = #{id}
	</delete>
	

   <insert id="insertRetireUser" parameterType="RetireUserDTO">
      INSERT INTO RETIRE_USERS
         (USER_NO, ID, JOIN_DATE, RETIRE_DATE)
      VALUES
		(#{userNo}, #{id}, #{joinDate}, NOW())
   </insert>
    
<!-- 	<select id="selectReportUserList" parameterType="map" resultMap="RedBellMap">
		SELECT A.ROW_NUM, A.R_NO, A.ID, A.R_CONTENT, A.R_DATE, A.R_GUBUN, A.R_TARGET, A.S_NO, A.GRP_NICKNAME, A.S_CMT_NO, A.CMT_NICKNAME
		  FROM (SELECT ROW_NUMBER() OVER(ORDER BY R_NO DESC) AS ROW_NUM, R.R_NO, R.ID, R.R_CONTENT, R.R_DATE, R.R_GUBUN, R.R_TARGET, G.S_NO, G.NICKNAME AS GRP_NICKNAME, C.S_CMT_NO, C.NICKNAME AS CMT_NICKNAME
		  		  FROM REDBELL R 
		         RIGHT OUTER JOIN S_GROUP G
		            ON R.R_TARGET = G.S_NO
		         RIGHT OUTER JOIN S_CMT C
		            ON R.R_TARGET = C.S_CMT_NO) A 
		   <where> 
		      <if test="rGubun == 1">
		         R.R_TARGET = #{sNo} 	         
		      </if>
		      <if test="rGubun == 2">
		         R.R_TARGET = #{sCmtNo}  	         
		      </if>
		      AND A.ROW_NUM BETWEEN #{begin} AND #{end} 
      	  </where>
	</select>	 -->
	
		<resultMap type="GrpRedbellDTO" id="GrpRedbellMap">
		<id property="rNo" column="R_NO"/>
		<result property="title" column="TITLE"/>
		<result property="content" column="CONTENT"/>
		<result property="hit" column="HIT"/>
		<result property="ip" column="IP"/>
		<result property="createDate" column="CREATE_DATE"/>
		<result property="modifyDate" column="MODIFY_DATE"/>
		<association property="USERS" javaType="UserDTO">
			<id property="userNo" column="USER_NO"/>
			<result property="id" column="ID"/>
		</association>
		<association property="S_GROUP" javaType="StudyGroupDTO">
			<id property="sNo" column="S_NO"/>
			<result property="nickname" column="NICKNAME"/>
		</association>
		</resultMap>
	
	<!-- R.ID는 모임장 -->
	<select id="selectReportList" parameterType="Map" resultMap="GrpRedbellMap">
	<!-- R.ID 신고당하는사람  R_ID = U_ID -->
		SELECT A.ROW_NUM, A.RED_NO, A.REPORTED,  A.STUD_NO, A.RED_CONTENT, A.RED_DATE, A.REPORTER_ID, A.NICKNAME
		  FROM (SELECT ROW_NUMBER() OVER(ORDER BY R_NO DESC) AS ROW_NUM, R.RED_NO, S.NICKNAME AS REPORTED, R.STUD_NO, R.RED_CONTENT, R.RED_DATE, U.ID AS REPORTER_ID,
		          FROM USERS U 
		         INNER JOIN GRP_REDBELL R
		            ON U.ID = R.ID
		         INNER JOIN S_GROUP S
		            ON R.S_NO = S.S_NO) A
		  WHERE A.ROW_NUM BETWEEN #{begin} AND #{end}           
	</select>
	
	

</mapper>
	
	
	
	